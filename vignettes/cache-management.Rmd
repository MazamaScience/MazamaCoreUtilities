---
title: "Cache Managment"
author: "Thomas Bergamaschi"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Cache Management}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette illustrates the usage of ```manageCache()```, a function for managing space in a web cache. It is desirable when building a web service to store commonly requested products to avoid time wasted by reproducing them. Because the cache has finite disk space allocated to it, the cache should be routinely purged of old or outdated files to make room new ones. The ```manageCache()``` utility function simplifies this process.

## An Example
Lets first make a cache directory and put some data in it.

``` {r createCache}
# Create a cache directory
CACHE_DIR <- file.path(tempdir(), 'cache')
if ( file.exists(CACHE_DIR) == FALSE ) {
  dir.create(CACHE_DIR)
}

# Add a few files to the cache
write.csv(matrix(1,400,500), file=file.path(CACHE_DIR,'m1.csv'))
Sys.sleep(1) # wait a bit between each to give them different mtime
write.csv(matrix(2,400,500), file=file.path(CACHE_DIR,'m2.csv'))
Sys.sleep(1)
write.csv(matrix(3,400,500), file=file.path(CACHE_DIR,'m3.csv'))
Sys.sleep(1)
write.csv(matrix(4,400,500), file=file.path(CACHE_DIR,'m4.csv'))
```

We can look in our new cache directory and see the four files we just added, and we can see that the directory contains about 1.5 MB of data.

``` {r checkCache}
cachedFiles <- list.files(CACHE_DIR, full.names = TRUE)
infoDF <- file.info(cachedFiles)
cacheSize = (sum(infoDF$size) / 1e6) # in MB
print(list.files(CACHE_DIR))
sprintf("Cache size = %s MB", cacheSize)
```

In order to simulate file requests, lets read two of them to update their access time.

``` {r accessFiles, echo=FALSE}
# Access two of the files, updating their atime
invisible( read.csv(file.path(CACHE_DIR, 'm1.csv')) )
invisible( read.csv(file.path(CACHE_DIR, 'm2.csv')) )
```

Now, lets use ```manageCache()``` to get our cache down to 1 MB.

``` {r manageCache}
# Use manageCache() to get cache to 1 MB
library(MazamaCoreUtils)
manageCache(CACHE_DIR, extensions = 'csv', maxCacheSize = 1)
```

When we check our cache again, we will see that the two files that were least recently accessed are gone, and the cache size is now under 1 MB.

``` {r checkCacheAgain}
# Check cache contents and total size again
cachedFiles <- list.files(CACHE_DIR, full.names = TRUE)
infoDF <- file.info(cachedFiles)
cacheSize = (sum(infoDF$size) / 1e6) # in MB
print(list.files(CACHE_DIR))
sprintf("Cache size = %s MB", cacheSize)
```


